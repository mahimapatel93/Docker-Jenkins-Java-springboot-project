name: Deploy to EC2 via SSH

on:
  workflow_dispatch:
  # push:
  #   branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment"

            mkdir -p ${{ secrets.APP_PATH }}
            cd ${{ secrets.APP_PATH }}

            # Clone if not exists
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone https://github.com/mahimapatel93/Docker-Jenkins-Java-springboot-project.git
            else
              echo "ğŸ“¥ Pulling latest code..."
              git fetch --all
              git reset --hard origin/main
            fi

            echo "ğŸ³ Build backend"
            cd backend
            sudo docker build -t springboot-backend .
            cd ..

            echo "ğŸ³ Build frontend"
            cd frontend
            sudo docker build -t streamlit-frontend .
            cd ..

            echo "ğŸŒ Create network"
            sudo docker network inspect app-network >/dev/null 2>&1 || sudo docker network create app-network

            echo "ğŸ›‘ Stop old containers"
            sudo docker rm -f backend || true
            sudo docker rm -f frontend || true

            echo "â–¶ï¸ Start backend"
            sudo docker run -d \
              --name backend \
              --network app-network \
              --restart unless-stopped \
              -p 8084:8084 \
              springboot-backend

            echo "â–¶ï¸ Start frontend"
            sudo docker run -d \
              --name frontend \
              --network app-network \
              --restart unless-stopped \
              -p 8501:8501 \
              streamlit-frontend

            echo "ğŸ§¹ Cleaning unused images"
            sudo docker image prune -f

            echo "ğŸ“¦ Running containers:"
            sudo docker ps

            echo "âœ… Deployment completed successfully..."
