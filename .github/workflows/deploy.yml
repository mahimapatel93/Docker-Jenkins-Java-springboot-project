name: Deploy to EC2 via SSH

on:
  workflow_dispatch: 
  #push:
    #branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Deploy Application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment"
        
          cd ${{ secrets.APP_PATH }}
        
          echo "ğŸ“‚ Current files:"
          ls -la
        
          echo "ğŸ“¥ Pull latest code"
          git fetch --all
          git reset --hard origin/main
        
          echo "ğŸ³ Build backend"
          cd backend
          ls
          sudo docker build -t springboot-backend .
          cd ..
        
          echo "ğŸ³ Build frontend"
          cd frontend
          ls
          sudo docker build -t streamlit-frontend .
          cd ..
        
          echo "ğŸŒ Create network"
          sudo docker network create app-network || true
        
          echo "ğŸ›‘ Stop old containers"
          sudo docker rm -f backend || true
          sudo docker rm -f frontend || true
        
          echo "â–¶ï¸ Start backend"
          sudo docker run -d \
            --name backend \
            --network app-network \
            -p 8084:8084 \
            springboot-backend
        
          echo "â–¶ï¸ Start frontend"
          sudo docker run -d \
            --name frontend \
            --network app-network \
            -p 8501:8501 \
            streamlit-frontend
        
          echo "ğŸ“¦ Running containers:"
          sudo docker ps
        
          echo "âœ… Deployment complete"
